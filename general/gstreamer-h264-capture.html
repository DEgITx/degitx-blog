<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css?family=Saira&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Overpass+Mono|Source+Code+Pro&display=swap" rel="stylesheet">

    <title>GStreamer H264/MP4 decoding C/C++ basics and encoding/decoding buffers manipulations | Alexey Kasyanchuk &mdash; Senior Software Developer </title>
    <meta property="og:title" content="GStreamer H264/MP4 decoding C/C++ basics and encoding/decoding buffers manipulations | Alexey Kasyanchuk &mdash; Senior Software Developer " />
    <meta name="twitter:title" content="GStreamer H264/MP4 decoding C/C++ basics and encoding/decoding buffers manipulations | Alexey Kasyanchuk &mdash; Senior Software Developer " />

    <meta name="description" content="Alexey Kasyanchuk GStreamer video capture camera basics">
    <meta name="description" property="og:description" content="Alexey Kasyanchuk GStreamer video capture camera basics" />
    <meta name="twitter:description" content="Alexey Kasyanchuk GStreamer video capture camera basics" />
    <meta name="keywords" content="C, C++, Java, Python, Performance, Android, Java, Git, Github, StackOverflow, algorithm, Qt, DEgITx, Kasyanchuk, Gitlab" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@degitx" />
    
    <meta property="og:url" content="https://blog.degitx.com/general/gstreamer-h264-capture.html" />

    <meta property="og:image" content="" />
    <meta name="twitter:image" content="" />

    <meta name="author" content="Alexey Kasyanchuk" />

    <meta name="copyright" content="Copyright by Alexey Kasyanchuk. All Rights Reserved." />

    <style>
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 300;
            src: local('Roboto Light'), local('Roboto-Light'), url(https://fonts.gstatic.com/s/roboto/v15/Hgo13k-tfSpn0qi1SFdUfVtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: local('Roboto'), local('Roboto-Regular'), url(https://fonts.gstatic.com/s/roboto/v15/CWB0XYA8bzo0kSThX0UTuA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 700;
            src: local('Roboto Bold'), local('Roboto-Bold'), url(https://fonts.gstatic.com/s/roboto/v15/d-6IYplOFocCacKzxwXSOFtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 900;
            src: local('Roboto Black'), local('Roboto-Black'), url(https://fonts.gstatic.com/s/roboto/v15/mnpfi9pxYH-Go5UiibESIltXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 300;
            src: local('Roboto Light Italic'), local('Roboto-LightItalic'), url(https://fonts.gstatic.com/s/roboto/v15/7m8l7TlFO-S3VkhHuR0at44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 400;
            src: local('Roboto Italic'), local('Roboto-Italic'), url(https://fonts.gstatic.com/s/roboto/v15/vPcynSL0qHq_6dX7lKVByfesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 700;
            src: local('Roboto Bold Italic'), local('Roboto-BoldItalic'), url(https://fonts.gstatic.com/s/roboto/v15/t6Nd4cfPRhZP44Q5QAjcC44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 900;
            src: local('Roboto Black Italic'), local('Roboto-BlackItalic'), url(https://fonts.gstatic.com/s/roboto/v15/bmC0pGMXrhphrZJmniIZpY4P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }
    </style>
    
    <link href="/favicon.png" rel="shortcut icon" type="image/x-icon" />
    
    <link rel="stylesheet" href="https://blog.degitx.com/assets/css/main.css">

    <link rel="canonical" href="https://blog.degitx.com/general/gstreamer-h264-capture.html">

    <link rel="alternate" type="application/rss+xml" title="" href="https://blog.degitx.com/feed.xml">

    <script src="https://blog.degitx.com/assets/js/jquery-1.12.2.min.js"></script>
<script src="https://blog.degitx.com/assets/js/backtotop.js"></script>
<script src="https://blog.degitx.com/assets/js/lunr.min.js"></script>
<script src="https://blog.degitx.com/assets/js/lunr-feed.js"></script>
<script src="https://blog.degitx.com/assets/js/jquery.fitvids.js"></script>
<script src="https://blog.degitx.com/assets/js/svg4everybody.min.js"></script>
<script src="https://blog.degitx.com/assets/js/scripts.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NF83F10V5F"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-NF83F10V5F');
    </script>


<script>
const host_address = "https://blog.degitx.com".replace('https://', '');
if (window.location.host == host_address && window.location.protocol == "http:") {
  window.location.protocol = "https:"
}
</script>

</head>

    <body>
        <div class="wrapper">
            <aside class="user-profile fixed" role="complementary">
    <div class="burger">
        <input class="trigger hidden" id="toggleBurger" type="checkbox" />
        <label for="toggleBurger">
            <span>Navigation</span>
        </label>
    </div>

    <div class="compact-header">
        <a class="avatar" href="https://blog.degitx.com"><img alt="Avatar" src="/degitx.jpg" /></a>
        <div class="my-info">
            <strong class="my-name">Alexey Kasyanchuk</strong>
            <span class="my-job-title">Senior Software Developer</span>
        </div>
    </div>

    
        
        <div class="mainmenu">
            <a href="/" >Blog</a>
            
                
            
                
            
                
            
                
                    <a href="https://blog.degitx.com/resume/" >About</a>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </div>
        
    

    <p class="about-me">Alexey Kasyanchuk - Senior Software Engineer with 10 years of expiriece in C/C++, Java, Python. I share expiriece.</p>

    <ul class="socials">
        <li class="twitter"><a href="http://twitter.com/DEgITx"><svg title="twitter" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li><li class="github"><a href="http://github.com/DEgITx"><svg title="github" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#github-icon"></use></svg></a></li><li class="linkedin"><a href="https://www.linkedin.com/in/alexey-kasyanchuk-60301456/"><svg title="linkedin" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#linkedin-icon"></use></svg></a></li><li class="stack-overflow"><a href="https://stackoverflow.com/users/1315059/degitx"><svg title="stack-overflow" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#stack-overflow-icon"></use></svg></a></li>

        
            <li class="email"><a href="mailto:degitx@gmail.com"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#email-icon"></use></svg></a></li>
        

        
         <li class="rss-feed"><a href="https://blog.degitx.com/feed.xml"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#rss-icon"></use></svg></a></li>
        
    </ul>
</aside>

            <main class="the-content" role="main">
                
                <article class="post single" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2020-10-22T23:32:00+00:00" itemprop="datePublished">22 Oct, 2020</time></li>
            
                
                <li class="cats">
                    
                        <a href="/categories/general/">general</a>
                    
                </li>
                
            
        </ul>
        <h2 itemprop="name headline">GStreamer H264/MP4 decoding C/C++ basics and encoding/decoding buffers manipulations</h2>
    </header>

    <div class="post-content">
        <h3 id="exploring-gstreamer-and-pipelines">Exploring GStreamer and pipelines</h3>

<p>Before proceeding to code review, let’s look at what we can do without it.  GStreamer includes useful utilities to work with, in particular:</p>

<ul>
  <li>gst-inspect-1.0 will allow you to see a list of available codecs and modules, so you can immediately see what will do with it and select a set of filters and codecs.</li>
  <li>gst-launch-1.0 allows you to start any pipeline.
GStreamer uses a decoding scheme where a stream passes through different components in series, from source to sink output. You can choose anything as a source: a file, a device, the output (sink) also may be a file, a screen, network outputs, and protocols (like RTP).</li>
</ul>

<p>Simple example of using gst-launch-1.0 to connect elements and play audio:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>gst-launch-1.0 filesrc <span class="nv">location</span><span class="o">=</span>/path/to/file.ogg <span class="o">!</span> decodebin <span class="o">!</span> alsasink
</pre></td></tr></tbody></table></code></pre></figure>

<figure>
  <img src="/images/gstreamer/sinksrc.png" />
  <figcaption>How to sink and src works</figcaption>
</figure>

<p>Filesrc will open file, decodebin - decode it, and alsasink will output audio.</p>

<p>Another more complex example of playing an mp4 file:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>gst-launch-1.0 filesrc <span class="nv">location</span><span class="o">=</span>file.mp4 <span class="o">!</span> qtdemux <span class="o">!</span> h264parse <span class="o">!</span> avdec_h264 <span class="o">!</span> videoconvert <span class="o">!</span> autovideosink
</pre></td></tr></tbody></table></code></pre></figure>

<p>The input accepts the mp4 file, which goes through the mp4 demuxer — qtdemux, then through the h264 parser, then through the decoder, the converter, and finally, the output.</p>

<p>You can replace autovideosink with filesink with a file parameter and output the decoded stream directly to the file.</p>

<h3 id="programming-an-application-with-gstreamer-cc-api-lets-try-to-decode">Programming an application with GStreamer C/C++ API. Let’s try to decode</h3>

<p>Now when we know how to use gst-launch-1.0, we are doing the same thing within our application. The principle remains the same: we are building in a decoding pipeline, but now we are using the GStreamer library and glib-events.</p>

<p>We will consider a live example of H264 decoding.</p>

<p>Initialization of the GStreamer application takes place once with the help of</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">gst_init</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<!--more-->

<p>If you want to see what’s happening in detail, you can set up a logging level before the initialization.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">gst_debug_set_active</span><span class="p">(</span><span class="n">TRUE</span><span class="p">);</span>
<span class="n">gst_debug_set_default_threshold</span><span class="p">(</span><span class="n">GST_LEVEL_LOG</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Note: no matter how many pipelines you have in your application, it is enough to initialize gst_init once.</p>

<p>Let’s create a new event-loop where events will be processed:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">GMainLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">;</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">g_main_loop_new</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And now we can start building our pipeline. Let’s name the necessary elements, in particular, the pipeline itself as the GstElement type:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">demuxer</span><span class="p">,</span> <span class="o">*</span><span class="n">parser</span><span class="p">,</span> <span class="o">*</span><span class="n">decoder</span><span class="p">,</span> <span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
 
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"video-decoder"</span><span class="p">);</span>
<span class="n">source</span>   <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"filesrc"</span><span class="p">,</span>       <span class="s">"file-source"</span><span class="p">);</span>
<span class="n">demuxer</span>  <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"qtdemux"</span><span class="p">,</span>      <span class="s">"h264-demuxer"</span><span class="p">);</span>
<span class="n">parser</span>   <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"h264parse"</span><span class="p">,</span>      <span class="s">"h264-parser"</span><span class="p">);</span>
<span class="n">decoder</span>  <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"avdec_h264"</span><span class="p">,</span>     <span class="s">"h264-decoder"</span><span class="p">);</span>
<span class="n">conv</span>     <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"videoconvert"</span><span class="p">,</span>  <span class="s">"converter"</span><span class="p">);</span>
<span class="n">sink</span>     <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"appsink"</span><span class="p">,</span> <span class="s">"video-output"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Each element of the pipeline is created via gst_element_factory_make, where the first parameter is the type and the second is its conditional name for GStreamer, on which it will later rely (for example, when issuing errors).</p>

<p>It would also be nice to check that all components are found otherwise gst_element_factory_make returns NULL.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">demuxer</span> <span class="o">||</span> <span class="o">!</span><span class="n">parser</span> <span class="o">||</span> <span class="o">!</span><span class="n">decoder</span> <span class="o">||</span> <span class="o">!</span><span class="n">conv</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// one element is not initialized - stop</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We are setting the same location parameter via g_object_set:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="s">"location"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Other parameters in other elements can be set in the same way.</p>

<p>Now we need the GStreamer message handler, let’s create the corresponding bus_call:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
 
<span class="n">guint</span> <span class="n">bus_watch_id</span><span class="p">;</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">gst_pipeline_get_bus</span> <span class="p">(</span><span class="n">GST_PIPELINE</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">));</span>
<span class="n">bus_watch_id</span> <span class="o">=</span> <span class="n">gst_bus_add_watch</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">bus_call</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>gst_object_unref and other similar calls are needed to clear selected objects.</p>

<p>Then we will name the message handler itself:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="k">static</span> <span class="n">gboolean</span>
<span class="nf">bus_call</span> <span class="p">(</span><span class="n">GstBus</span>     <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
          <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
          <span class="n">gpointer</span>    <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="p">(</span><span class="n">GMainLoop</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
      <span class="n">LOGI</span> <span class="p">(</span><span class="s">"End of stream</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  
    <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">gchar</span>  <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
      <span class="n">GError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
 
      <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">);</span>
      <span class="n">g_free</span> <span class="p">(</span><span class="n">debug</span><span class="p">);</span>
      <span class="n">LOGE</span> <span class="p">(</span><span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
      <span class="n">g_error_free</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
      <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And now the most important thing: we collect and add all the created elements in a single pipeline, which was built through gst-launch. The order of addition is, of course, important:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="n">demuxer</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">demuxer</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We should also note that this linking of elements works perfectly for stream outputs, but in the case of playback (autovideosink) requires additional synchronization and dynamic linking of the demuxer and parser:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="n">gst_element_link</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">demuxer</span><span class="p">);</span>
<span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">demuxer</span><span class="p">,</span> <span class="s">"pad-added"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">on_pad_added</span><span class="p">),</span> <span class="n">parser</span><span class="p">);</span>
 
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">on_pad_added</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">element</span><span class="p">,</span>
              <span class="n">GstPad</span>     <span class="o">*</span><span class="n">pad</span><span class="p">,</span>
              <span class="n">gpointer</span>    <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">sinkpad</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
 
  <span class="cm">/* We can now link this pad with the sink pad */</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Dynamic pad created, linking demuxer/decoder</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  
  <span class="n">sinkpad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">sinkpad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">sinkpad</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>A dynamic connection makes it possible to determine the type and number of threads in contrast to a static one and will work in some cases when it is required.</p>

<p>And finally, let’s turn the conveyor status into a playback:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And let’s run event-loop:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">g_main_loop_run</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After this procedure, everything needs to be cleaned:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">GST_OBJECT</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">));</span>
<span class="n">g_source_remove</span> <span class="p">(</span><span class="n">bus_watch_id</span><span class="p">);</span>
<span class="n">g_main_loop_unref</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="choosing-encoders-and-decoders-fallbacks">Choosing encoders and decoders. Fallbacks.</h3>

<p>There’s more to tell about useful but barely mentioned things in the documentation: how you can easily organize a fallback decoder or encoder.</p>

<p>The gst_element_factory_find function will help us do this by checking if we have a codec in the elements factory:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">if</span><span class="p">(</span><span class="n">gst_element_factory_find</span><span class="p">(</span><span class="s">"omxh264dec"</span><span class="p">))</span>
  <span class="n">decoder</span>  <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"omxh264dec"</span><span class="p">,</span>     <span class="s">"h264-decoder"</span><span class="p">);</span>
<span class="k">else</span>
  <span class="n">decoder</span>  <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"avdec_h264"</span><span class="p">,</span>     <span class="s">"h264-decoder"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In this example, we have prioritized the selection of an OMX hardware decoder on the RDK platform, and in case of its absence, we will choose a software implementation.</p>

<p>Another extremely useful but even more rarely used feature is to check what we actually initialized in GstElement (which of many codecs):</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">gst_plugin_feature_get_name</span><span class="p">(</span><span class="n">gst_element_get_factory</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>You can do it in such a simple way and return the name of the initialized codec.</p>

<h3 id="video-color-models">Video color models</h3>

<p>We can’t help but mention color models as well since we are talking about encoding video from cameras. And that’s when YUV goes on stage (much more often than RGB).</p>

<p>Cameras simply love the YUYV color model. But GStreamer likes to work with the usual I420 model much better. If it is not about outputting in the gl-frame, we will also have I420 frames. Get ready to set up the filters you need and perform the transformations.</p>

<p>Some encoders can work with other color models as well, but more often, these are exceptions to the rule.</p>

<p>We should also note that GStreamer has its own module for receiving video streams from your camera, and it can be used to build a pipeline, but we will talk about it some other time.</p>

<p>Let’s deal with buffers and take data on the fly</p>

<h4 id="input-buffer">Input buffer</h4>

<p>It’s time to deal with the data flows. Until now, we have simply encoded through filesrc what is in the file and displayed everything in the same filesink or on the screen.</p>

<p>Now we will work with the buffers and the appsrc / appsink inputs and outputs. For some reason, this issue was hardly taken into account in the official documentation.</p>

<p>So how to organize a constant data flow in the created pipelines, or if to be more precise to the output buffer and get an encoded or decoded output buffer? Let’s say we got the image from the camera and we need to encode it. We have already decided that we need a frame in the I420 format. Let’s say we have it, what’s next? How do I pass a picture through the whole pipeline flow?</p>

<p>First, let’s set up the need-data event handler, which will be started when it is necessary to feed data into the pipeline and start feeding the input buffer:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">"need-data"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">encoder_cb_need_data</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The handler itself has the following form:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="n">encoder_cb_need_data</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">appsrc</span><span class="p">,</span>
                      <span class="n">guint</span>       <span class="n">unused_size</span><span class="p">,</span>
                      <span class="n">gpointer</span>    <span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
  <span class="n">GstFlowReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="n">GstMapInfo</span> <span class="n">map</span><span class="p">;</span>
 
  <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="mi">640</span> <span class="o">*</span> <span class="mi">480</span><span class="p">;</span> <span class="c1">// typical I420 640x480 image for example</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">image</span><span class="p">;</span> <span class="c1">// prepared I420 image data (replace with your buffer)</span>
  
  <span class="c1">// Copy image to the buffer</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">gst_buffer_new_allocate</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">gst_buffer_map</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="n">GST_MAP_WRITE</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">((</span><span class="n">guchar</span> <span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span>  <span class="n">gst_buffer_get_size</span><span class="p">(</span> <span class="n">buffer</span> <span class="p">)</span> <span class="p">);</span>
  <span class="n">gst_buffer_unmap</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
  <span class="n">g_signal_emit_by_name</span> <span class="p">(</span><span class="n">appsrc</span><span class="p">,</span> <span class="s">"push-buffer"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
  <span class="n">gst_buffer_unref</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>You might say that “image” is the pseudo-code of our image buffer in I420.</p>

<p>Next, we create a buffer of the necessary size through gst_buffer_new_allocate, which will correspond to the size of the image buffer.</p>

<p>With gst_buffer_map we set the buffer to write mode and use memcpy to copy our image to the created buffer.</p>

<p>And finally, we signal GStreamer that the buffer is ready.</p>

<p>Note: it is essential to use gst_buffer_unmap after writing and to clear the buffer after using gst_buffer_unref. Otherwise, there will be a memory leak. In the low number of available examples, no one was particularly concerned about memory usage, although this is very important.</p>

<p>Now, when we are done with the handler, one more thing to do is to configure caps on the receipt of our expected format.</p>

<p>This is done before installing the need-data signal handler:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">source</span><span class="p">),</span>
              <span class="s">"stream-type"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s">"format"</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="s">"caps"</span><span class="p">,</span>
              <span class="n">gst_caps_new_simple</span> <span class="p">(</span><span class="s">"video/x-raw"</span><span class="p">,</span>
                                   <span class="s">"format"</span><span class="p">,</span> <span class="n">G_TYPE_STRING</span><span class="p">,</span> <span class="s">"I420"</span><span class="p">,</span>
                                   <span class="s">"width"</span><span class="p">,</span> <span class="n">G_TYPE_INT</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>
                                   <span class="s">"height"</span><span class="p">,</span> <span class="n">G_TYPE_INT</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span>
                                   <span class="s">"framerate"</span><span class="p">,</span> <span class="n">GST_TYPE_FRACTION</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="nb">NULL</span><span class="p">),</span>
              <span class="nb">NULL</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Like all GstElement parameters, the parameters are set via g_object_set.</p>

<p>In this case, we have defined the stream type and its caps — the data format. We are specifying that the appsrc output will receive the I420 data with 640×480 resolution and 30 frames per second.</p>

<p>Frequency in our case, and in general, does not play any role. While working, we haven’t noticed that GStreamer somehow limits need-data calls by frequency.</p>

<p>Finished, now our frames are fed into the encoder.</p>

<h4 id="output-buffer">Output buffer</h4>

<p>Now let’s find out how to get an encoded output stream.</p>

<p>We connect the handler to the sink pad:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="n">GstPad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
<span class="n">gst_pad_add_probe</span>  <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">GST_PAD_PROBE_TYPE_BUFFER</span><span class="p">,</span> <span class="n">encoder_cb_have_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pad</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Similarly, we connected to another sink pad event, GST_PAD_PROBE_TYPE_BUFFER, which would be triggered as the data buffer enters the sink pad.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="k">static</span> <span class="n">GstPadProbeReturn</span>
<span class="nf">encoder_cb_have_data</span> <span class="p">(</span><span class="n">GstPad</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span>
                      <span class="n">GstPadProbeInfo</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
                      <span class="n">gpointer</span> <span class="n">user_data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">gst_pad_probe_info_get_buffer</span> <span class="p">(</span><span class="n">info</span><span class="p">);</span>
  <span class="n">GstMemory</span> <span class="o">*</span><span class="n">bufMem</span> <span class="o">=</span> <span class="n">gst_buffer_get_memory</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">GstMapInfo</span> <span class="n">bufInfo</span><span class="p">;</span>
 
  <span class="n">gst_memory_map</span><span class="p">(</span><span class="n">bufMem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufInfo</span><span class="p">,</span> <span class="n">GST_MAP_READ</span><span class="p">);</span>
 
  <span class="c1">// bufInfo.data, bufInfo.size will contain encoded image data as output of out pipeline</span>
  <span class="n">gst_memory_unmap</span><span class="p">(</span><span class="n">bufMem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufInfo</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">GST_PAD_PROBE_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The callback has a similar structure. Now, we need to reach the buffer memory. First, we get GstBuffer, then a pointer of its memory using gst_buffer_get_memory by index 0 (as a rule, it is the only one involved). Finally, using gst_memory_map, we get the data buffer address bufInfo.data and its size bufInfo.size.</p>

<p>Using same technique you can pass and recive encoded or decoded data with any complex pipeline using decoding elements or encoding elements or even using filters. I will recomend to prepare and test you pipeline using gst-launch-1.0 console utility at first, and then build same pipeline using native code.</p>

    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=GStreamer H264/MP4 decoding C/C++ basics and encoding/decoding buffers manipulations&p[summary]=Exploring GStreamer and pipelines

Before proceeding to code review, let’s look at what we can do without it.  GStreamer includes useful ...&p[url]=https://blog.degitx.com/general/gstreamer-h264-capture.html" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=https://blog.degitx.com/general/gstreamer-h264-capture.html&text=Exploring GStreamer and pipelines

Before proceeding to code review, let’s look at what we can do without it.  GStreamer includes useful ...&hashtags=gstreamer,C++,native,aac,streaming,video capture," rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blog.degitx.com/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
                <li><a href="https://blog.degitx.com/tag/gstreamer">gstreamer</a></li>
                
                <li><a href="https://blog.degitx.com/tag/C++">C++</a></li>
                
                <li><a href="https://blog.degitx.com/tag/native">native</a></li>
                
                <li><a href="https://blog.degitx.com/tag/aac">aac</a></li>
                
                <li><a href="https://blog.degitx.com/tag/streaming">streaming</a></li>
                
                <li><a href="https://blog.degitx.com/tag/video capture">video capture</a></li>
                
            </ul>
        </div>
        
    </footer>
</article>


<aside class="comments" role="complementary">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'https://blog.degitx.com/general/gstreamer-h264-capture.html';
            this.page.identifier = '10/22/2020';
        };
        (function() {
            var d = document, s = d.createElement('script');

            s.src = '//degitx.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
</aside>

            </main>
        </div>
    </body>
</html>